<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css" />
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        #container {border: 1px solid black;}
        H1 {float: left;}

        .button{
            background-color:orange;
            border: 1px solid #229;
            border-radius: 10px;
            width: 100px;
            float: right;
            font-size: 2em;
            color: white;
            text-align: center;
        }

        #addReceiptBox{
            display: none;
            background-color: orange;
            border: 1px solid black;
            float: right;
            width: 200px;
        }

        #receiptList {
            border: 1px solid black;
            background-color: lightblue;
            clear: both;
        }

        .receipt {
            background-color: lightblue;
            margin-bottom: 5px;
        }

    </style>
    <script>
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        $(function(){
            const api = ""; // <- do not need a root api URL if this page is served directly by the API
            $.getJSON(api+"/receipts", function(receipts){
                var id_seen = [];
                for(var i=0; i < receipts.length; i++) {
                    var receipt = receipts[i];
                    if($.inArray(receipt.id, id_seen)==-1) {
                        $(`<div class="receipt" id="${receipt.id}"><div class="merchant">${receipt.merchantName}</div>
                        <div class="amount">${receipt.value}</div>
                        <div class="tagsBox">Tags: <button class="add-tag">Add +</button></div></div>`)
                            .appendTo($("#receiptList"));
                        id_seen.push(receipt.id);
                    }
                    if(receipt.name != null){
                        $(`<button class="tagValue">${receipt.name}</button>`)
                            .appendTo($('.tagsBox', $("#"+receipt.id)));
                    }
                    //alert(receipt.name);

                }
            })
        })

        $(document).on('click','.add-tag',function(){
            $(this).after("<input class='tag_input' style='height:20px;margin-left:10px;width:40px' type='text'></input>");
        });

        $(document).on('click','.tagValue',function(){
            $.ajax({
                type: 'PUT',
                url: '/tags/'+$(this).text(),
                data: $(this).parent().parent().attr('id'),
                contentType: "application/json",
                dataType: 'json',
                success: function(data) {
                    //
                }
            });
            $(this).remove();
        });


        $(document).on('keypress','.tag_input',function(e){
            var tag = $(this).val();
            if(e.keyCode == 13)
            {
                $.ajax({
                    type: 'PUT',
                    url: '/tags/'+$(this).val(),
                    data: $(this).parent().parent().attr('id'),
                    contentType: "application/json",
                    dataType: 'json',
                    success: function(data) {
                        //alert($(this).parent().parent().attr('id'));
                    }
                });
                $(`<button class="tagValue">${tag}</button>`)
                    .appendTo($('.tagsBox', $("#"+$(this).parent().parent().attr('id'))));
                $(this).remove();

            }
        });

        $(document).ready(function(){

            $("#add-receipt").click(function(){
                $("#addReceiptBox").show();
            });


            $("#cancel-receipt").click(function(){
                $("#addReceiptBox").hide();
            });

            $("#save-receipt").click(function(){
                $.ajax({
                    type: 'POST',
                    url: '/receipts',
                    data: JSON.stringify({merchant:$("#merchant").val(),amount:($("#amount").val())}),
                    contentType: "application/json",
                    dataType: 'json',
                    success: function(data) {
                        $(`<div class="receipt" id="${data}"><div class="merchant">${$("#merchant").val()}</div>
                        <div class="amount">${$("#amount").val()}</div>
                        <div class="tagsBox">Tags: <button class="add-tag">Add +</button></div></div>`)
                            .appendTo($("#receiptList"));
                    }
                });
                $("#addReceiptBox").hide();
            });
        });

    </script>
</head>

<body>
<DIV id="container">
    <h1>My receipts</h1>
    <div class="button" id="add-receipt">+</div>
    <div id="addReceiptBox">
        <p><input style='height:20px;margin-left:10px;width:178px;background-color:orange' id='merchant' placeholder="merchant" type='text'></p>
        <p><input style='height:20px;margin-left:10px;width:178px;background-color:orange' id='amount' placeholder="amount" type='text'></p>
        <button style='height:20px;margin-left:100px' id="cancel-receipt">cancel</button>
        <button style='height:20px' id="save-receipt">save</button>
    </div>

    <div id="receiptList">
    </div>
</DIV>
</body>

</html>
